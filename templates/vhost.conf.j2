<VirtualHost *:{{ httpd_http_port }}>

    ServerName {{ item.servername }}
    DocumentRoot {{ item.documentroot }}
    CustomLog logs/{{ item.servername }}-access_log combined
    ErrorLog logs/{{ item.servername }}-error_log

    {% if item.ssl_offloaded is defined and item.ssl_offloaded -%}
    SetEnvIf X-Forwarded-Proto https HTTPS=on
    {% endif %}

{% if python_wsgi_apps is defined and python_wsgi_apps[item.servername] is defined and python_wsgi_apps[item.servername]|length > 0 %}
{% for wsgi_app in python_wsgi_apps[item.servername] %}
{% if wsgi_app.alias is defined and wsgi_app.file is defined %}
    WSGIDaemonProcess {{ item.servername }}.{{ wsgi_app.name}} processes={{ wsgi_app.processes }} threads={{ wsgi_app.threads }} user={{ wsgi_app.user }} group={{ wsgi_app.group }} umask={{ wsgi_app.umask }}
{% endif %}
{% endfor %}
{% endif %}


    {% if item.redirect_http_to_https is defined and item.redirect_http_to_https -%}
    RewriteEngine On
    RewriteRule .* https://%{SERVER_NAME}%{REQUEST_URI} [R,L]
    {% else -%}
    Include conf.d/vhost_{{ item.servername }}.common.conf
    {% endif %}

</VirtualHost>

{% if ssl_certificates is defined and ssl_certificates[item.servername] is defined and ssl_certificates[item.servername].private_key is defined and ssl_certificates[item.servername].certificate is defined and httpd_mod_ssl %}
<VirtualHost *:443>

    ServerName {{ item.servername }}
    DocumentRoot {{ item.documentroot }}
    CustomLog logs/{{ item.servername }}-access_log combined
    ErrorLog logs/{{ item.servername }}-error_log

    Include conf.d/vhost_{{ item.servername }}.common.conf

    SSLEngine On
    SSLCertificateFile /etc/pki/tls/certs/{{ item.servername }}.crt
    SSLCertificateKeyFile /etc/pki/tls/private/{{ item.servername }}.key
    {% if ssl_certificates[item.servername].chain is defined -%}
    SSLCertificateChainFile /etc/pki/tls/certs/{{ item.servername }}.chain.crt
    {%- endif %}

</VirtualHost>
{% endif %}